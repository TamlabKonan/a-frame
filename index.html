<html>
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script>
      AFRAME.registerComponent("quest3-locomotion", {
        schema: {
          moveSpeed: { default: 3 },
          turnSpeed: { default: 1.5 }
        },

        init() {
          this.camera = document.querySelector("[camera]").object3D;
        },

        tick(time, delta) {
          const dt = delta / 1000;
          const session = this.el.sceneEl.renderer.xr.getSession();
          if (!session) return;

          // XR InputSource を取得
          const sources = session.inputSources;

          for (const src of sources) {
            if (!src.gamepad) continue;

            const pad = src.gamepad;
            // Quest3 TouchPlus のスティック配列
            // axes[0], axes[1] = 左スティック
            // axes[2], axes[3] = 右スティック
            const lx = pad.axes[0] || 0; // 左スティック：左右
            const ly = pad.axes[1] || 0; // 左スティック：前後
            const rx = pad.axes[2] || 0; // 右スティック：回転

            // ---- 移動（前後左右） ----
            if (Math.abs(lx) > 0.1 || Math.abs(ly) > 0.1) {
              const rig = this.el.object3D;

              // HMD の向きベクトル
              const forward = new THREE.Vector3();
              this.camera.getWorldDirection(forward);
              forward.y = 0;
              forward.normalize();

              // 右方向
              const right = new THREE.Vector3().crossVectors(
                forward,
                new THREE.Vector3(0, 1, 0)
              ).normalize();

              // 移動量
              const move = new THREE.Vector3();
              move.addScaledVector(forward, -ly * this.data.moveSpeed * dt);
              move.addScaledVector(right, lx * this.data.moveSpeed * dt);

              rig.position.add(move);
            }

            // ---- 回転（滑らか旋回） ----
            if (Math.abs(rx) > 0.2) {
              const rig = this.el.object3D;
              rig.rotation.y -= rx * this.data.turnSpeed * dt;
            }
          }
        }
      });
    </script>
  </head>

  <body>
    <a-scene>
      <a-sky color="#ECECEC"></a-sky>
      <a-plane width="200" height="200" rotation="-90 0 0" color="#7BC8A4"></a-plane>

      <!-- プレイヤー/Rig -->
      <a-entity id="rig" quest3-locomotion position="0 1.6 0">
        <a-entity camera></a-entity>

        <!-- Quest コントローラ -->
        <a-entity oculus-touch-controls="hand: left"></a-entity>
        <a-entity oculus-touch-controls="hand: right"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
